apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: cockroachdb
  namespace: cockroachdb
spec:
  chart:
    spec:
      chart: cockroachdb
      version: "11.2.1"
      sourceRef:
        kind: HelmRepository
        name: cockroachdb
        namespace: cockroachdb
  interval: 1h0m0s
  install:
    crds: Create
  upgrade:
    crds: CreateReplace
  values:
    conf:
      single-node: true
    statefulset:
      replicas: 1
      resources:
        limits:
          cpu: 300m
          memory: 512Mi
        requests:
          cpu: 100m
          memory: 200Mi

    service:
      public:
        type: LoadBalancer
        annotations:
          external-dns.alpha.kubernetes.io/hostname: cockroachdb.local

    # Cockroachdb UI
    ingress:
      enabled: true
      annotations:
        cert-manager.io/cluster-issuer: default-clusterissuer
      hosts:
      - cockroachdb-console.local
      tls:
      - hosts:
        - cockroachdb-console.local
        secretName: cockroachdb-tls
    
    storage:
      persistentVolume:
        enabled: true
        size: 10Gi
        storageClass: longhorn

    provisioning:
      enabled: true
      # https://www.cockroachlabs.com/docs/stable/cluster-settings.html
      clusterSettings:
        # cluster.organization: "'FooCorp - Local Testing'"
        # enterprise.license: "'xxxxx'"
      users:
      - name: test
        password: test
        # https://www.cockroachlabs.com/docs/stable/create-user.html#parameters
        options: [LOGIN]
      databases:
      - name: nextcloud
      #   # https://www.cockroachlabs.com/docs/stable/create-database.html#parameters
      #   options: [encoding='utf-8']
      #   owners: []
      #   # https://www.cockroachlabs.com/docs/stable/grant.html#parameters
      #   owners_with_grant_option: []
      #   # Backup schedules are not idemponent for now and will fail on next run
      #   # https://github.com/cockroachdb/cockroach/issues/57892
      #   backup:
      #     into: s3://
      #     # Enterprise-only option (revision_history)
      #     # https://www.cockroachlabs.com/docs/stable/create-schedule-for-backup.html#backup-options
      #     options: [revision_history]
      #     recurring: '@always'
      #     # Enterprise-only feature. Remove this value to use `FULL BACKUP ALWAYS`
      #     fullBackup: '@daily'
      #     schedule:
      #       # https://www.cockroachlabs.com/docs/stable/create-schedule-for-backup.html#schedule-options
      #       options: [first_run = 'now']
      #
      #
    tls:
      enabled: false
