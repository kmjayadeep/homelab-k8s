apiVersion: apps/v1
kind: Deployment
metadata:
  name: openvpn-gateway
  namespace: vpn-gateway
spec:
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: openvpn-gateway
  template:
    metadata:
      labels:
        app: openvpn-gateway
    spec:
      volumes:
        - name: openvpn-config
          secret:
            secretName: openvpn-config
            optional: false
      containers:
      - name: netshoot
        image: nicolaka/netshoot:latest
        command: ["/bin/sleep", "3650d"]
        securityContext:
          capabilities:
            add: ["NET_ADMIN"]
      - image: tecnativa/tcp-proxy:v1.0.1
        name: tcp-proxy
        env:
          - name: LISTEN
            value: ":443 :6443" # The listen address that it will be exposed to.
          - name: TALK
            value: "192.168.0.102:443 192.168.0.15:6443"
      - name: openvpn
        image: dperson/openvpn-client:latest
        # allow route to kubernetes service ip and local network
        args: ["-r", "10.90.0.0/16", "-r", "192.168.0.0/24"]
        securityContext:
          capabilities:
            add: ["NET_ADMIN"]
        volumeMounts:
        - name: openvpn-config
          mountPath: /vpn
          readOnly: true
