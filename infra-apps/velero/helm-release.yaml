apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: velero
  namespace: velero
spec:
  interval: 1h0m0s
  chart:
    spec:
      chart: velero
      version: '2.29.4'
      sourceRef:
        kind: HelmRepository
        name: vmware-tanzu
        namespace: flux-system
      interval: 1m
  values:

    deployRestic: true

    credentials:
      useSecret: true
      existingSecret: b2-creds # Deployed as a sealed secret

    configuration:
      provider: aws

      backupStorageLocation:
        name: default
        provider: aws
        bucket: andromeda-k8s-backup
        config:
          s3Url: https://s3.us-west-000.backblazeb2.com
          region: eu-central-2

      volumeSnapshotLocation:
        name: default
        provider: aws
        config:
          s3Url: https://s3.us-west-000.backblazeb2.com
          region: eu-central-2

    initContainers:
    - name: velero-plugin-for-aws
      image: velero/velero-plugin-for-aws:v1.4.0
      imagePullPolicy: IfNotPresent
      volumeMounts:
        - mountPath: /target
          name: plugins

    schedules:
      backup-pihole:
        disabled: false
        useOwnerReferencesInBackup: false
        schedule: "0 0/6 * * *" # Every 6 hours
        template:
          includedNamespaces:
          - 'pihole'
          includedResources: # Just deployment and pod should be enough. It includes the PVC as well. Other resources are in git already
          - 'deployments'
          - 'pods'
          snapshotVolumes: true
          ttl: 87600h # Automatically delete backup CR from the cluster after 10 years. Original backup in the bucket is ALSO deleted
          defaultVolumesToRestic: false # only backup pods which have volume names annotated to be backed up
          metadata:
            labels:
              project: pihole
      backup-prometheus:
        disabled: false
        useOwnerReferencesInBackup: false
        schedule: "0 0/6 * * *" # Every 6 hours
        template:
          includedNamespaces:
          - 'monitoring'
          includedResources: # Just deployment and pod should be enough. It includes the PVC as well. Other resources are in git already
          - 'deployments'
          - 'pods'
          labelSelector:
            matchLabels:
              app: prometheus
          snapshotVolumes: true
          ttl: 87600h # Automatically delete backup CR from the cluster after 10 years. Original backup in the bucket is ALSO deleted
          defaultVolumesToRestic: false # only backup pods which have volume names annotated to be backed up
          metadata:
            labels:
              project: prometheus
      backup-pihole:
        disabled: false
        useOwnerReferencesInBackup: false
        schedule: "0 0/6 * * *" # Every 6 hours
        template:
          includedNamespaces:
          - 'syncthing'
          includedResources: # Just deployment and pod should be enough. It includes the PVC as well. Other resources are in git already
          - 'deployments'
          - 'pods'
          snapshotVolumes: true
          ttl: 87600h # Automatically delete backup CR from the cluster after 10 years. Original backup in the bucket is ALSO deleted
          defaultVolumesToRestic: false # only backup pods which have volume names annotated to be backed up
          metadata:
            labels:
              project: syncthing
